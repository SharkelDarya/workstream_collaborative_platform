<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/style.css">
    <title> - Workspace - </title>
</head>
<body>
    <div class="wrapper">
        <div class="container">
            <h3>Welcome to <span id="name_workspace"></span> Workspace!</h3>
            <h4>Members: </h4>
            <div class="addMember">
                <form onsubmit="AddNewMember(event)">
                    <label>Name:</label>
                    <input type="text" name="name_member">
                    <label>Role:</label>
                    <select name="role" id="role">
                        <option value="Member">Member</option>
                        <option value="Admin">Admin</option>
                    </select>
                    <input type="submit" value="Add member">  
                </form>  
            </div>

            <div id="members"></div>

            <h4>Channels: </h4>
            <div class="addChannel">
                <form id="form_add_channel" onsubmit="AddNewChannel(event)">
                    <label>Name:</label>
                    <input type="text" name="name_channel">
                    <label>Public/Private:</label>
                    <select name="type_channel" id="type_channel">
                        <option value="Public">Public</option>
                        <option value="Private">Private</option>
                    </select>
                    <input type="submit" value="Add channel">  
                </form>  
            </div>

            <div id="channels"></div> 
        </div>
        <div class="container">
            <div class="chat">
                <h3><span id="name_channel">Choose channel!</span> | chat:</h3>
                <div class="all_mess">Nothing.</div>
                <div class="form_mess">
                    <form id="send_mess">
                        <input type="text" name="text_mess" placeholder="Enter the message">
                        <input type="submit" name="send_mess_submit" value="Send">
                    </form>
                </div>
            </div>
        </div>
        <div class="container">
            <h3>Jobs</h3>
            <div class="addJob">
                <form id="form_add_job">
                    <label>Type:</label>
                    <select name="type_job" required>
                        <option value="CSV Export">CSV Export</option>
                        <option value="Data Processing">Data Processing</option>
                        <option value="Report Generation">Report Generation</option>
                        <option value="Fake Processing">Fake Processing</option>
                    </select>
                    <input type="submit" value="Add job">  
                </form>  
            </div>
            <div id="jobs"></div> 
    </div>
<!-- Load Workspace -->
<script>
    async function LoadWorkspaceInfo() {
        const token = localStorage.getItem('token');
        const urlParams = new URLSearchParams(window.location.search);
        const workspace_id = urlParams.get("workspace_id");

        if (!workspace_id) {
            alert("Workspace ID not found in URL!");
            return;
        }

        const res = await fetch(`/api/workspace?id=${workspace_id}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (res.ok) {
            const data = await res.json();
            const workspace = data.workspace;
            const users = data.users;
            const channels = data.channels
            const jobs = data.jobs

            document.getElementById('name_workspace').textContent = workspace.name;

            const membersDiv = document.getElementById('members');
            membersDiv.innerHTML = ''; 

            if (!users || users.length === 0) {
                membersDiv.textContent = "No members yet.";
            } else {
                const ul = document.createElement('ul');

                users.forEach(user => {
                    const li = document.createElement('li');
                    li.textContent = `${user.name} \t [${user.role}] \t`;
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.className = 'delete-member-btn';
                    deleteBtn.onclick = () => deleteMember(user.id);
                
                    li.appendChild(deleteBtn);
                    ul.appendChild(li);
                });

                membersDiv.appendChild(ul);
            }

            const channelsDiv = document.getElementById('channels');
            channelsDiv.innerHTML = ''; 
            if (!channels || channels.length === 0) {
                channelsDiv.textContent = "No channels yet.";
            } else {
                const ul = document.createElement('ul');

                channels.forEach(channel => {
                    const li = document.createElement('li');
                    const link = document.createElement('a');
                    const tag = document.createElement('span');

                    link.textContent = channel.name;
                    link.href = `/workspace.html?workspace_id=${workspace_id}&channel_id=${encodeURIComponent(channel.id)}`;
                    link.className = 'link';

                    if(channel.isPrivate == false)
                    {
                        tag.textContent = `\t [Public] \t`;
                    } else {
                        tag.textContent = `\t  [Private] \t`;
                    }
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.className = 'delete-channel-btn';
                    deleteBtn.onclick = () => deleteChannel(channel.id);
                
                    li.appendChild(link);
                    li.appendChild(tag);
                    li.appendChild(deleteBtn);
                    ul.appendChild(li);
                });

                channelsDiv.appendChild(ul);
            }

            // const jobsDiv = document.getElementById('jobs');
            // jobsDiv.innerHTML = ''; 

            // if (!jobs || jobs.length === 0) {
            //     jobsDiv.textContent = "No jobs yet.";
            // } else {
            //     const ul = document.createElement('ul');

            //     jobs.forEach(job => {
            //         const li = document.createElement('li');
            //         li.textContent = `${job.type} \t [${job.status}] \t [${job.progress}] \t`;
                    
            //         const deleteBtn = document.createElement('button');
            //         deleteBtn.textContent = 'Delete';
            //         deleteBtn.className = 'delete-job-btn';
            //         deleteBtn.onclick = () => deleteJob(job.id);
                
            //         li.appendChild(deleteBtn);
            //         ul.appendChild(li);
            //     });

            //     jobsDiv.appendChild(ul);
            // }
        } else {
            const error = await res.json();
            alert(error.message || "Failed to load workspace");
        }
    }

    async function deleteMember(userId) {
        const token = localStorage.getItem('token');
        const urlParams = new URLSearchParams(window.location.search);
        const workspace_id = urlParams.get("workspace_id");

        const res = await fetch(`/api/delete_member?workspace_id=${workspace_id}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id_user: userId })
        });

        if (res.ok) {
            alert("Member deleted successfully!");
            window.location.reload();
        } else {
            const err = await res.json();
            alert(err.message || "Error deleting member");
        }
    }

    async function deleteChannel(channelId) {
        const token = localStorage.getItem('token');
        const urlParams = new URLSearchParams(window.location.search);
        const workspace_id = urlParams.get("workspace_id");

        const res = await fetch(`/api/delete_channel?workspace_id=${workspace_id}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ workspace_id, channelId })
        });

        if (res.ok) {
            alert("Channel deleted successfully!");
            window.location.reload();
        } else {
            const err = await res.json();
            alert(err.message || "Error deleting Channel");
        }
    }

        // async function deleteJob(jobId) {
        // const token = localStorage.getItem('token');
        // const urlParams = new URLSearchParams(window.location.search);
        // const workspace_id = urlParams.get("workspace_id");

        // const res = await fetch(`/api/delete_job?workspace_id=${workspace_id}`, {
        //     method: 'POST',
        //     headers: {
        //         'Authorization': `Bearer ${token}`,
        //         'Content-Type': 'application/json'
        //     },
        //     body: JSON.stringify({ id_job: jobId })
        // });

        // if (res.ok) {
        //     alert("Job deleted successfully!");
        //     window.location.reload();
        // } else {
        //     const err = await res.json();
        //     alert(err.message || "Error deleting job");
        // }
    LoadWorkspaceInfo();
</script>

<!-- Load Chat -->
<script src="/socket.io/socket.io.js"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
    const socket = io();
    const token = localStorage.getItem('token');
    const channel_id = new URLSearchParams(window.location.search).get('channel_id');

    if (!channel_id) return;

    const resChannel = await fetch(`/api/channel?id=${channel_id}`, {
        headers: { 'Authorization': `Bearer ${token}` }
    });
    if (resChannel.ok) {
        const channelData = await resChannel.json();
        document.getElementById('name_channel').textContent = channelData.channel.name;
    }

    const resUser = await fetch('/api/user', { headers: { 'Authorization': `Bearer ${token}` } });
    const user = await resUser.json();

    socket.emit('join channel', { channel_id });

    const chatBox = document.querySelector('.all_mess');
    socket.on('channel history', (messages) => {
        chatBox.innerHTML = '';
        messages.forEach(msg => {
            const div = document.createElement('div');
            div.textContent = `${msg.user.name}: ${msg.text}`;
            chatBox.appendChild(div);
        });
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    document.getElementById('send_mess').addEventListener('submit', (e) => {
        e.preventDefault();
        const input = e.target.elements.text_mess;
        const text = input.value.trim();
        if (!text) return;

        socket.emit('send message', { channel_id, user_id: user.id, text });
        input.value = '';
    });

    socket.on('new message', (msg) => {
        if (msg.channelId != channel_id) return;
        const div = document.createElement('div');
        div.textContent = `${msg.userName}: ${msg.text}`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    });
});
</script>

<!-- Load Jobs  -->
<script src="/JobUIController.js"></script>
<script>
const jobController = new JobUIController();

document.getElementById('form_add_job')?.addEventListener('submit', function(e) {
  e.preventDefault();
  const type = this.querySelector('select[name="type_job"]').value;
  jobController.createJob(type);
  this.reset();
});
</script>

<!-- Add New Members | Add New Channels | Add New Jobs -->
<script>
    async function AddNewMember(event) {
        event.preventDefault();
        const token = localStorage.getItem('token');
        const name = document.querySelector('input[name="name_member"]').value;
        const role = document.querySelector('select[name="role"]').value;
        const urlParams = new URLSearchParams(window.location.search);
        const id_workspace = urlParams.get("workspace_id");
         

        const res = await fetch('/api/add_members', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id_workspace, name, role })
        });

        if (res.ok) {
            const data = await res.json();
            window.location.reload();
        } else {
            alert("Error add user!");
        }
    }

    async function AddNewChannel(event) {
        event.preventDefault();
        const token = localStorage.getItem('token');
        const name = document.querySelector('input[name="name_channel"]').value;
        const type = document.querySelector('select[name="type_channel"]').value;
        const urlParams = new URLSearchParams(window.location.search);
        const workspace_id = urlParams.get("workspace_id");
        
        const isPrivate = (type === "Private");

        const res = await fetch('/api/add_channel', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ workspace_id, name, isPrivate })
        });

        if (res.ok) {
            const data = await res.json();
            window.location.reload();
        } else {
            alert("Error add channel!");
        }
    }

    async function AddNewJob(event) {
        event.preventDefault();
        const token = localStorage.getItem('token');
        const type = document.querySelector('input[name="type_job"]').value;
        const urlParams = new URLSearchParams(window.location.search);
        const workspace_id = urlParams.get("workspace_id");

        const res = await fetch('/api/add_job', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ workspace_id, type })
        });

        if (res.ok) {
            const data = await res.json();
            window.location.reload();
        } else {
            alert("Error add job!");
        }
    }
</script>

</body>
</html>